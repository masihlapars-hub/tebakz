<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tebak Tebakan - Kuis Seru</title>
  <style>
    :root{
      --primary-color:#4a6fa5; --secondary-color:#6b8cbc; --accent-color:#ff6b6b;
      --background-color:#f5f7fa; --text-color:#333; --card-bg:#ffffff;
      --header-bg:#4a6fa5; --font-weight:bold;
    }
    .theme-dark{
      --primary-color:#2c3e50; --secondary-color:#34495e; --accent-color:#e74c3c;
      --background-color:#1a1a2e; --text-color:#ecf0f1; --card-bg:#16213e; --header-bg:#2c3e50;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:var(--background-color);color:var(--text-color);font-weight:var(--font-weight);transition:.3s}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:var(--header-bg);color:#fff;padding:15px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    nav{display:flex;justify-content:space-between;align-items:center;padding:0 20px}
    .logo{font-size:1.5rem;font-weight:bold;cursor:pointer}
    .nav-links{display:flex;gap:16px}
    .nav-links a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:4px}
    .nav-links a:hover{background:var(--secondary-color)}
    #admin-link{display:none;} /* disembunyikan sampai unlock */

    .page{display:none;min-height:80vh;padding:20px}
    .page.active{display:block}
    .card{background:var(--card-bg);border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1);padding:20px;margin-bottom:20px}
    .btn{background:var(--primary-color);color:#fff;border:0;padding:10px 18px;border-radius:6px;cursor:pointer;font-weight:bold}
    .btn:hover{background:var(--secondary-color)}
    .btn-sm{padding:8px 14px;font-size:.9rem;margin:4px}

    .login-container{display:flex;flex-direction:column;align-items:center;min-height:60vh;gap:14px}
    .avatar-selection,.theme-selection{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .avatar-option{width:72px;height:72px;border-radius:50%;object-fit:cover;cursor:pointer;border:3px solid transparent;transition:.2s}
    .avatar-option.selected{border-color:var(--primary-color);transform:scale(1.06)}
    .theme-option{padding:8px 14px;border:2px solid var(--primary-color);border-radius:6px;cursor:pointer}
    .theme-option.selected{background:var(--primary-color);color:#fff}

    .category-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:10px}
    .category-item{background:var(--card-bg);border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.08);padding:16px;text-align:center}
    .category-image{width:96px;height:96px;object-fit:cover;border-radius:10px;margin-bottom:8px}
    .level-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}

    .question-image{max-width:100%;max-height:280px;border-radius:8px;margin:12px 0}
    .options-container{display:flex;flex-direction:column;gap:10px}
    .option{padding:14px;border:2px solid #ddd;border-radius:8px;cursor:pointer}
    .option.selected{background:var(--secondary-color);color:#fff;border-color:var(--primary-color)}
    .progress-bar{height:10px;background:#eee;border-radius:6px;margin:10px 0;overflow:hidden}
    .progress{height:100%;background:var(--primary-color);width:0%}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#eef2ff}

    @media(max-width:768px){
      .category-grid{grid-template-columns:1fr}
      .question-image{max-height:200px}
    }
  </style>
  <!-- Firebase (compat) untuk simple usage; aman dipakai read-only publik -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="theme-light">
  <header>
    <nav>
      <div class="logo" title="Klik 3x untuk Admin">Tebak Tebakan</div>
      <div class="nav-links">
        <a href="#" id="home-link">Home</a>
        <a href="#" id="score-link">Top Score</a>
        <a href="#" id="admin-link">Admin</a>
        <a href="#" id="logout-link">Logout</a>
      </div>
    </nav>
  </header>

  <div class="container">
    <!-- Login -->
    <div id="login-page" class="page active">
      <div class="card">
        <div class="login-container">
          <h2>Login Pemain</h2>
          <div style="width:100%;max-width:520px">
            <label for="player-name" style="display:block;margin:6px 0;font-weight:bold">Nama Pemain</label>
            <input id="player-name" type="text" placeholder="Masukkan nama Anda" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;background:var(--card-bg);color:var(--text-color)"/>
          </div>

          <h3>Pilih Avatar</h3>
          <div id="avatar-selection" class="avatar-selection"></div>

          <h3>Pilih Tema</h3>
          <div id="theme-selection" class="theme-selection"></div>

          <button id="start-game-btn" class="btn">Mulai Bermain</button>
        </div>
      </div>
    </div>

    <!-- Home -->
    <div id="home-page" class="page">
      <div class="card">
        <h2>Selamat Datang, <span id="player-greeting">Pemain</span>!</h2>
        <p>Pilih kategori dan tingkat kesulitan untuk mulai bermain.</p>
      </div>
      <div id="category-grid" class="category-grid"></div>
    </div>

    <!-- Top Score -->
    <div id="score-page" class="page">
      <div class="card">
        <h2>Top Score</h2>
        <p id="score-empty" style="display:none;margin:8px 0">Belum ada skor. Main dulu ya!</p>
        <div style="overflow:auto">
          <table id="score-table" aria-label="Top Score">
            <thead>
              <tr>
                <th>#</th><th>Nama</th><th>Skor</th><th>Benar/Total</th><th>Kategori</th><th>Level</th><th>Durasi</th><th>Tanggal</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Quiz -->
    <div id="quiz-page" class="page">
      <div class="card">
        <div class="quiz-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2 id="quiz-category">Kategori:</h2>
          <div class="quiz-info" style="display:flex;gap:12px">
            <span id="quiz-level">Level:</span>
            <span id="question-number">Soal 1/1</span>
          </div>
        </div>
        <div class="progress-bar"><div id="quiz-progress" class="progress"></div></div>
        <div class="question-container">
          <h3 id="question-text">Pertanyaanâ€¦</h3>
          <img id="question-image" class="question-image" style="display:none" alt="Gambar Soal"/>
        </div>
        <div id="options-container" class="options-container"></div>
        <button id="next-question-btn" class="btn" style="margin-top:14px">Selanjutnya</button>
      </div>
    </div>

    <!-- Result -->
    <div id="result-page" class="page">
      <div class="card">
        <h2>Hasil Kuis</h2>
        <p id="score-display">Skor Anda: 0/0</p>
        <h3 style="margin:10px 0">Detail Jawaban</h3>
        <div id="answer-details"></div>
        <button id="back-to-home-btn" class="btn" style="margin-top:14px">Kembali ke Home</button>
      </div>
    </div>

    <!-- Admin (disembunyikan & terkunci) -->
    <div id="admin-page" class="page">
      <div class="card">
        <h2>Panel Admin</h2>
        <p>PIN admin: <code>281105</code> (diminta saat buka). Pemain biasa tidak akan melihat halaman ini.</p>
      </div>

      <div class="card">
        <h3>Tambah Soal Manual</h3>
        <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))">
          <div>
            <label>Kategori</label>
            <select id="question-category" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></select>
          </div>
          <div>
            <label>Level</label>
            <select id="question-level" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
              <option value="mudah">Mudah</option>
              <option value="normal">Normal</option>
              <option value="sulit">Sulit</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label>Pertanyaan</label>
            <textarea id="question-text" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></textarea>
          </div>
          <div><label>Opsi A</label><input id="option-a" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>
          <div><label>Opsi B</label><input id="option-b" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>
          <div><label>Opsi C</label><input id="option-c" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>
          <div><label>Opsi D</label><input id="option-d" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>
          <div>
            <label>Jawaban Benar</label>
            <select id="correct-answer" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
              <option value="a">A</option><option value="b">B</option>
              <option value="c">C</option><option value="d">D</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="add-question-btn" class="btn">Tambah Soal</button>
          <button id="delete-one-btn" class="btn" title="Hapus soal terakhir di kategori/level">Hapus Soal Terakhir</button>
        </div>
      </div>

      <div class="card">
        <h3>Impor / Ekspor Soal (JSON)</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px">
          <button id="btn-export" class="btn">Ekspor JSON</button>
          <input id="file-import" type="file" accept=".json" />
          <button id="btn-file-import-merge" class="btn">Impor File (Merge)</button>
          <button id="btn-file-import-replace" class="btn">Impor File (Ganti)</button>
        </div>
        <textarea id="import-text" rows="6" placeholder='Tempel JSON di sini' style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></textarea>
        <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="btn-import-merge" class="btn">Impor (Merge)</button>
          <button id="btn-import-replace" class="btn">Impor (Ganti)</button>
        </div>
      </div>

      <div class="card">
        <h3>Sinkron Cloud (Firebase Realtime Database)</h3>
        <p style="margin:6px 0 12px">Semua pemain **otomatis baca** dari cloud read-only. Admin saja yang bisa tulis.</p>
        <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))">
          <div><label>Namespace</label><input id="fb-namespace" value="prod" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></div>
          <div><label>Admin Email</label><input id="fb-email" placeholder="admin@email.com" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></div>
          <div><label>Admin Password</label><input id="fb-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="btn-fb-connect" class="btn">Connect (Read-Only)</button>
          <button id="btn-fb-admin-login" class="btn">Admin Login</button>
          <button id="btn-fb-pull" class="btn">Pull dari Cloud</button>
          <button id="btn-fb-push" class="btn">Push ke Cloud</button>
        </div>
        <p style="margin-top:10px;font-size:.9rem;color:#555">/* Rules contoh:
<pre style="white-space:pre-wrap;background:#f6f8fa;padding:8px;border-radius:6px;overflow:auto">
{
  "rules":{
    "tt":{
      "$ns":{
        "questions":{
          ".read": true,
          ".write": "auth != null && auth.token.email == 'adminmu@example.com'"
        }
      }
    }
  }
}
</pre>
        </p>
      </div>

      <div class="card">
        <h3>Top Score</h3>
        <button id="clear-scores-btn" class="btn" title="Hapus seluruh top score">Reset Top Score</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Error overlay ---------- */
    window.onerror = function(msg, src, line, col){
      const b = document.createElement('div');
      b.style.cssText='position:fixed;left:0;right:0;top:0;z-index:99999;background:#ffdddd;color:#900;padding:8px;font:12px monospace';
      b.textContent='JS ERROR: '+msg+' @ '+line+':'+col;
      document.body.appendChild(b);
    };

    /* -------------------- CONFIG -------------------- */
    const ADMIN_PASSWORD = '281105';
    const LS_KEY = 'tebakTebakanData_v3';
    // Ganti dengan config Firebase kamu (boleh public).
    const FB_CONFIG = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    /* -------------------- STATE -------------------- */
    let adminUnlocked = false;  // gate UI Admin
    const appData = {
      currentPlayer:{name:'Pemain',avatar:'',theme:'theme-light',score:0},
      currentQuestions:[],
      currentQuestionIndex:0,
      userAnswers:[],
      currentCategory:'',
      currentLevel:'',
      quizStartAt:0,
      scores:[],  // {name, score, total, category, level, ms, date}
      categories:[
        {id:'ipa',name:'IPA',description:'Ilmu Pengetahuan Alam',image:''},
        {id:'ips',name:'IPS',description:'Ilmu Pengetahuan Sosial',image:''},
        {id:'utbk',name:'UTBK',description:'Ujian Tulis Berbasis Komputer',image:''},
        {id:'agama',name:'Agama',description:'Pendidikan Agama',image:''},
        {id:'tebak-receh',name:'Tebak Receh',description:'Tebakan Receh',image:''},
        {id:'cpns',name:'CPNS',description:'Tes CPNS',image:''},
        {id:'logika',name:'Logika',description:'Tes Logika',image:''},
        {id:'mtk',name:'MTK',description:'Tes Matematika',image:''},
        {id:'it',name:'IT',description:'Soal IT',image:''},
        {id:'agama hindu',name:'Agama Hindu',description:'Soal Agama Hindu',image:''},
        {id:'agama buddha',name:'Agama Buddha',description:'Soal Agama Buddha',image:''},
        {id:'agama katolik',name:'Agama Katolik',description:'Soal Agama Katolik',image:''},
        {id:'agama konghucu',name:'Agama Konghucu',description:'Soal Agama Konghucu',image:''},
        {id:'agama protestan',name:'Agama Protestan',description:'Soal Agama Protestan',image:''},
        {id:'agama kristen',name:'Agama Kristen',description:'Soal Agama Kristen',image:''}
      ],
      avatars:[
        './static/avatars/3f983b9ca5618e87e3734751e643c00a.jpg',
        './static/avatars/23f038cc913bb02b9b58bc7d8418dd6d.jpg',
        './static/avatars/41bb3d263d7697d065daef857a33bad9.jpg',
        './static/avatars/adad96e29d8f85ab783efedc4bf77339.jpg',
        './static/avatars/b4be2a5c52b166134c6a6b219836dcb1.jpg',
        './static/avatars/4e339904b7614b9f80ba2d1f65c62ea1.jpg', // monyet
        './static/avatars/c69a2653915d4f413e5450f1a87a2bc5.jpg',
        './static/avatars/be6f89e2633168738acf2deb817cfeb6.jpg',
        './static/avatars/a975a06b73c871fd961c088eb19ed64a (1).jpg'
      ],
      themes:[
        {id:'theme-light-1',name:'Terang 1',class:'theme-light'},
        {id:'theme-dark-1',name:'Gelap 1',class:'theme-dark'}
      ]
    };

    // soal awal minimal (fallback local)
    const sampleQuestions = {
      ipa:{
        mudah:[
          {id:1,question:'Planet terdekat dari matahari?',options:{a:'Venus',b:'Bumi',c:'Mars',d:'Merkurius'},correctAnswer:'d',image:''},
          {id:2,question:'Fungsi mitokondria?',options:{a:'Fotosintesis',b:'Pembangkit energi sel',c:'Kontrol aktivitas sel',d:'Sintesis protein'},correctAnswer:'b',image:''}
        ],
        normal:[],sulit:[]
      },
      it:{
        mudah:[
          {id:1,question:'HTML kepanjangannya?',options:{a:'Hyperlinks and Text Markup Language',b:'HyperText Markup Language',c:'Home Tool Markup Language',d:'Hyper Text Makeup Language'},correctAnswer:'b',image:''}
        ],
        normal:[],sulit:[]
      }
    };

    /* -------------------- INIT -------------------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      setupEventListeners();
      setupAdditionalThemes();
      loadFromLocalStorage();           // player/theme/avatar aman
      renderAvatarOptions();
      renderThemeOptions();
      renderCategories();
      renderCategoryOptionsForAdmin();
      // Auto-connect read-only cloud utk SEMUA user (pemain tidak perlu admin)
      autoConnectCloudRO();
    });

    function setupAdditionalThemes(){
      const style=document.createElement('style');
      style.textContent=`
        .theme-light-2{--primary-color:#6d4c41;--secondary-color:#8d6e63;--accent-color:#ff5722;--background-color:#f5f5f5;--text-color:#212121;--card-bg:#fff;--header-bg:#6d4c41}
        .theme-light-3{--primary-color:#388e3c;--secondary-color:#4caf50;--accent-color:#ffc107;--background-color:#e8f5e9;--text-color:#1b5e20;--card-bg:#fff;--header-bg:#388e3c}
        .theme-light-4{--primary-color:#1976d2;--secondary-color:#2196f3;--accent-color:#ff5252;--background-color:#e3f2fd;--text-color:#0d47a1;--card-bg:#fff;--header-bg:#1976d2}
        .theme-dark-2{--primary-color:#7b1fa2;--secondary-color:#9c27b0;--accent-color:#ff4081;--background-color:#1a1a1a;--text-color:#e1bee7;--card-bg:#2d2d2d;--header-bg:#7b1fa2}
        .theme-dark-3{--primary-color:#d32f2f;--secondary-color:#f44336;--accent-color:#ff9800;--background-color:#1a1a1a;--text-color:#ffcdd2;--card-bg:#2d2d2d;--header-bg:#d32f2f}
        .theme-dark-4{--primary-color:#00796b;--secondary-color:#009688;--accent-color:#ffeb3b;--background-color:#1a1a1a;--text-color:#b2dfdb;--card-bg:#2d2d2d;--header-bg:#00796b}
      `;
      document.head.appendChild(style);
      appData.themes.push(
        {id:'theme-light-2',name:'Terang 2',class:'theme-light-2'},
        {id:'theme-light-3',name:'Terang 3',class:'theme-light-3'},
        {id:'theme-light-4',name:'Terang 4',class:'theme-light-4'},
        {id:'theme-dark-2',name:'Gelap 2',class:'theme-dark-2'},
        {id:'theme-dark-3',name:'Gelap 3',class:'theme-dark-3'},
        {id:'theme-dark-4',name:'Gelap 4',class:'theme-dark-4'}
      );
    }

    function setupEventListeners(){
      document.getElementById('home-link').addEventListener('click',()=> showPage('home-page'));
      document.getElementById('score-link').addEventListener('click',()=>{ renderTopScores(); showPage('score-page'); });

      // Admin menu visible only after unlock
      document.getElementById('admin-link').addEventListener('click',()=>{
        if(!adminUnlocked){ showAdminLoginPrompt(); return; }
        showPage('admin-page');
      });

      document.getElementById('logout-link').addEventListener('click',logout);
      document.getElementById('start-game-btn').addEventListener('click',startGame);
      document.getElementById('next-question-btn').addEventListener('click',handleNextQuestion);
      document.getElementById('back-to-home-btn').addEventListener('click',()=>showPage('home-page'));
      document.getElementById('clear-scores-btn').addEventListener('click',()=>{
        if(confirm('Hapus semua top score?')){ appData.scores=[]; saveToLocalStorage(); renderTopScores(); alert('Top score direset.'); }
      });
      // pilih opsi
      document.addEventListener('click',e=>{
        if(e.target.classList.contains('option')){
          document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
          e.target.classList.add('selected');
          appData.userAnswers[appData.currentQuestionIndex]=e.target.dataset.option;
        }
      });
      // admin add/hapus
      document.getElementById('add-question-btn').addEventListener('click',()=>{ requireAdminOrBlock(); addQuestion(); });
      document.getElementById('delete-one-btn').addEventListener('click',()=>{ requireAdminOrBlock(); deleteLastQuestion(); });

      // import/export
      byId('btn-export').addEventListener('click', ()=>{ requireAdminOrBlock(); exportJSON(); });
      byId('btn-import-merge').addEventListener('click', ()=>{ requireAdminOrBlock(); importFromText(byId('import-text').value,'merge'); });
      byId('btn-import-replace').addEventListener('click', ()=>{ requireAdminOrBlock(); if(confirm('Mode GANTI akan menimpa kategori yang sama. Lanjut?')) importFromText(byId('import-text').value,'replace'); });
      byId('btn-file-import-merge').addEventListener('click', ()=>{
        requireAdminOrBlock();
        const f=byId('file-import').files[0]; if(!f) return alert('Pilih file .json');
        importFromFile(f,'merge');
      });
      byId('btn-file-import-replace').addEventListener('click', ()=>{
        requireAdminOrBlock();
        const f=byId('file-import').files[0]; if(!f) return alert('Pilih file .json');
        if(!confirm('Mode GANTI akan menimpa kategori yang sama. Lanjut?')) return;
        importFromFile(f,'replace');
      });

      // secret gesture open admin
      setupSecretOpen();
      // cloud buttons
      byId('btn-fb-connect').addEventListener('click', ()=>{ requireAdminOrBlock(); cloudConnectRO(); });
      byId('btn-fb-admin-login').addEventListener('click', ()=>{ requireAdminOrBlock(); cloudAdminLogin(); });
      byId('btn-fb-pull').addEventListener('click', ()=>{ requireAdminOrBlock(); pullFromCloudOnce(); });
      byId('btn-fb-push').addEventListener('click', ()=>{ requireAdminOrBlock(); pushToCloudNow(); });
    }

    function byId(id){ return document.getElementById(id); }

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    /* -------------------- LOGIN & HOME -------------------- */
    function renderAvatarOptions(){
      const c=document.getElementById('avatar-selection'); c.innerHTML='';
      appData.avatars.forEach((src,idx)=>{
        const img=document.createElement('img');
        img.src=src; img.alt='Avatar '+(idx+1);
        img.className='avatar-option';
        if(idx===0 && !appData.currentPlayer.avatar){ appData.currentPlayer.avatar=src; img.classList.add('selected'); }
        if(appData.currentPlayer.avatar===src){ img.classList.add('selected'); }
        img.addEventListener('click',()=>{
          document.querySelectorAll('.avatar-option').forEach(i=>i.classList.remove('selected'));
          img.classList.add('selected');
          appData.currentPlayer.avatar=src; saveToLocalStorage();
        });
        c.appendChild(img);
      });
    }

    function renderThemeOptions(){
      const c=document.getElementById('theme-selection'); c.innerHTML='';
      appData.themes.forEach((t,idx)=>{
        const el=document.createElement('div');
        el.textContent=t.name;
        el.className='theme-option';
        el.dataset.theme=t.class;
        if((idx===0 && !appData.currentPlayer.theme) || appData.currentPlayer.theme===t.class){
          el.classList.add('selected');
          document.body.classList.add(t.class);
        }
        el.addEventListener('click',()=>{
          document.querySelectorAll('.theme-option').forEach(i=>i.classList.remove('selected'));
          el.classList.add('selected');
          document.body.classList.remove(...appData.themes.map(x=>x.class));
          document.body.classList.add(t.class);
          appData.currentPlayer.theme=t.class; saveToLocalStorage();
        });
        c.appendChild(el);
      });
    }

    function renderCategories(){
      const grid=document.getElementById('category-grid'); grid.innerHTML='';
      appData.categories.forEach(cat=>{
        const box=document.createElement('div');
        box.className='category-item';
        box.innerHTML = `
          ${cat.image?`<img class="category-image" src="${cat.image}" alt="${cat.name}"/>`:''}
          <h3>${cat.name}</h3>
          <p>${cat.description||''}</p>
          <div class="level-buttons">
            <button class="btn btn-sm" data-category="${cat.id}" data-level="mudah">Mudah</button>
            <button class="btn btn-sm" data-category="${cat.id}" data-level="normal">Normal</button>
            <button class="btn btn-sm" data-category="${cat.id}" data-level="sulit">Sulit</button>
          </div>`;
        grid.appendChild(box);
        box.querySelectorAll('.level-buttons button').forEach(b=>{
          b.addEventListener('click',()=>startQuiz(b.dataset.category,b.dataset.level));
        });
      });
    }

    function startGame(){
      const name = (document.getElementById('player-name').value||'').trim();
      if(!name){ alert('Silakan isi nama dulu ya.'); return; }
      appData.currentPlayer.name=name;
      document.getElementById('player-greeting').textContent=name;
      saveToLocalStorage();
      showPage('home-page');
    }

    /* -------------------- QUIZ -------------------- */
    function startQuiz(category,level){
      appData.currentCategory=category;
      appData.currentLevel=level;
      appData.currentQuestionIndex=0;
      appData.userAnswers=[];
      appData.quizStartAt=Date.now();

      let qs=[];
      if(sampleQuestions[category] && sampleQuestions[category][level] && sampleQuestions[category][level].length){
        qs=sampleQuestions[category][level];
      }else{
        qs=[{id:1,question:`Contoh soal ${category} (${level})`,options:{a:'Opsi A',b:'Opsi B',c:'Opsi C',d:'Opsi D'},correctAnswer:'a',image:''}];
      }
      appData.currentQuestions=qs;

      document.getElementById('quiz-category').textContent='Kategori: '+category.toUpperCase();
      document.getElementById('quiz-level').textContent='Level: '+level;
      showPage('quiz-page');
      showQuestion(0);
    }

    function showQuestion(i){
      if(i>=appData.currentQuestions.length){ finishQuiz(); return; }
      const q=appData.currentQuestions[i];
      document.getElementById('question-text').textContent=q.question;
      document.getElementById('question-number').textContent=`Soal ${i+1}/${appData.currentQuestions.length}`;

      const qi=document.getElementById('question-image');
      if(q.image){ qi.src=q.image; qi.style.display='block'; }
      else { qi.style.display='none'; }

      document.getElementById('quiz-progress').style.width = (i/appData.currentQuestions.length*100)+'%';

      const oc=document.getElementById('options-container'); oc.innerHTML='';
      Object.entries(q.options).forEach(([k,v])=>{
        const d=document.createElement('div');
        d.className='option'; d.dataset.option=k; d.innerHTML=`<strong>${k.toUpperCase()}.</strong> ${v}`;
        if(appData.userAnswers[i]===k) d.classList.add('selected');
        oc.appendChild(d);
      });
    }

    function handleNextQuestion(){
      if(!appData.userAnswers[appData.currentQuestionIndex]){
        alert('Pilih jawaban dulu ya!');
        return;
      }
      appData.currentQuestionIndex++;
      showQuestion(appData.currentQuestionIndex);
    }

    function finishQuiz(){
      let score=0; const details=[];
      appData.currentQuestions.forEach((q,idx)=>{
        const ua=appData.userAnswers[idx];
        const ok=ua===q.correctAnswer;
        if(ok) score++;
        details.push({q:q.question,u:ua?q.options[ua]:'Tidak dijawab',c:q.options[q.correctAnswer],ok});
      });
      appData.currentPlayer.score=score;

      // ringkasan
      document.getElementById('score-display').textContent=`Skor Anda: ${score}/${appData.currentQuestions.length}`;
      const wrap=document.getElementById('answer-details'); wrap.innerHTML='';
      details.forEach((d,i)=>{
        const e=document.createElement('div');
        e.style.cssText=`margin:10px 0;padding:10px;border-left:4px solid ${d.ok?'#4caf50':'#f44336'};background:${d.ok?'#e8f5e9':'#ffebee'};border-radius:6px`;
        e.innerHTML=`<p><strong>Soal ${i+1}:</strong> ${d.q}</p><p><strong>Jawaban Anda:</strong> ${d.u}</p><p><strong>Jawaban Benar:</strong> ${d.c}</p>`;
        wrap.appendChild(e);
      });

      // Top Score lokal
      const ms = Math.max(1, Date.now()-appData.quizStartAt);
      addScore({
        name: appData.currentPlayer.name || 'Pemain',
        score, total: appData.currentQuestions.length,
        category: appData.currentCategory,
        level: appData.currentLevel,
        ms, date: new Date().toISOString()
      });

      showPage('result-page');
      saveToLocalStorage();
    }

    /* -------------------- TOP SCORE -------------------- */
    function addScore(rec){
      appData.scores.push(rec);
      appData.scores.sort((a,b)=>{
        if(b.score!==a.score) return b.score-a.score;
        if(a.ms!==b.ms) return a.ms-b.ms;
        return new Date(a.date)-new Date(b.date);
      });
      appData.scores = appData.scores.slice(0,100);
      saveToLocalStorage();
    }

    function renderTopScores(){
      const tbody = document.querySelector('#score-table tbody');
      const empty = document.getElementById('score-empty');
      tbody.innerHTML='';
      if(!appData.scores.length){
        empty.style.display='block'; return;
      }
      empty.style.display='none';
      appData.scores.forEach((s,idx)=>{
        const tr=document.createElement('tr');
        const dur = Math.round(s.ms/1000)+' dtk';
        const tgl = new Date(s.date).toLocaleString('id-ID');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHTML(s.name)}</td>
          <td>${s.score}</td>
          <td>${s.score}/${s.total}</td>
          <td>${s.category.toUpperCase()}</td>
          <td>${s.level}</td>
          <td>${dur}</td>
          <td>${tgl}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* -------------------- ADMIN: tambah/hapus -------------------- */
    function renderCategoryOptionsForAdmin(){
      const sel=document.getElementById('question-category'); sel.innerHTML='';
      appData.categories.forEach(c=>{
        const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o);
      });
    }

    function addQuestion(){
      const cat=document.getElementById('question-category').value;
      const lvl=document.getElementById('question-level').value;
      const qt=document.getElementById('question-text').value.trim();
      const a=document.getElementById('option-a').value.trim();
      const b=document.getElementById('option-b').value.trim();
      const c=document.getElementById('option-c').value.trim();
      const d=document.getElementById('option-d').value.trim();
      const correct=document.getElementById('correct-answer').value;

      if(!qt||!a||!b||!c||!d){ alert('Semua opsi wajib diisi.'); return; }
      if(!sampleQuestions[cat]) sampleQuestions[cat]={mudah:[],normal:[],sulit:[]};
      sampleQuestions[cat][lvl].push({id:Date.now(),question:qt,options:{a,b,c,d},correctAnswer:correct,image:''});

      document.getElementById('question-text').value='';
      document.getElementById('option-a').value='';
      document.getElementById('option-b').value='';
      document.getElementById('option-c').value='';
      document.getElementById('option-d').value='';
      alert('Soal ditambahkan!');
      saveToLocalStorage();
    }

    function deleteLastQuestion(){
      const cat=document.getElementById('question-category').value;
      const lvl=document.getElementById('question-level').value;
      if(!sampleQuestions[cat] || !sampleQuestions[cat][lvl] || !sampleQuestions[cat][lvl].length){
        alert('Belum ada soal di kategori/level ini.'); return;
      }
      sampleQuestions[cat][lvl].pop();
      alert('Soal terakhir dihapus.');
      saveToLocalStorage();
    }

    /* -------------------- IMPORT / EXPORT -------------------- */
    function exportJSON(){
      const dataStr = JSON.stringify(sampleQuestions, null, 2);
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'questions-export.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function importFromText(txt,mode='merge'){
      if(!txt.trim()) return alert('Tempel JSON dulu.');
      try{
        const obj = JSON.parse(txt);
        applyImport(obj, mode);
        alert('Impor sukses ('+mode+').');
        saveToLocalStorage();
      }catch(e){ alert('JSON tidak valid: '+e.message); }
    }

    function importFromFile(file,mode='merge'){
      const fr=new FileReader();
      fr.onload=()=>{ importFromText(fr.result, mode); };
      fr.readAsText(file);
    }

    function applyImport(obj,mode){
      Object.keys(obj||{}).forEach(cat=>{
        if(!sampleQuestions[cat]) sampleQuestions[cat]={mudah:[],normal:[],sulit:[]};
        ['mudah','normal','sulit'].forEach(lvl=>{
          const arr = Array.isArray(obj[cat][lvl]) ? obj[cat][lvl] : [];
          if(mode==='replace'){ sampleQuestions[cat][lvl] = arr; }
          else { sampleQuestions[cat][lvl] = [...(sampleQuestions[cat][lvl]||[]), ...arr]; }
        });
      });
    }

    /* -------------------- STORAGE -------------------- */
    function saveToLocalStorage(){
      const data = {
        categories: appData.categories,
        questions: sampleQuestions,
        player: appData.currentPlayer,   // simpan avatar/tema/nama
        scores: appData.scores
      };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    function loadFromLocalStorage(){
      const raw=localStorage.getItem(LS_KEY); if(!raw) return;
      try{
        const data=JSON.parse(raw);
        if(data.categories) appData.categories=data.categories;
        if(data.questions) Object.assign(sampleQuestions, data.questions);
        if(Array.isArray(data.scores)) appData.scores = data.scores;
        if(data.player){
          // JANGAN timpa avatar/tema kecuali ada
          appData.currentPlayer = {...appData.currentPlayer, ...data.player};
          document.getElementById('player-name').value=appData.currentPlayer.name||'';
          document.getElementById('player-greeting').textContent=appData.currentPlayer.name||'Pemain';
          if(appData.currentPlayer.theme){
            document.body.classList.remove(...appData.themes.map(t=>t.class));
            document.body.classList.add(appData.currentPlayer.theme);
          }
        }
      }catch(e){ console.warn('Parse localStorage gagal:', e); }
    }

    function logout(){
      if(!confirm('Yakin ingin logout?')) return;
      appData.currentPlayer={name:'Pemain',avatar:'',theme:'theme-light',score:0};
      saveToLocalStorage();
      showPage('login-page');
    }

    function escapeHTML(s=''){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    /* -------------------- ADMIN LOCK (secret + PIN + rate limit) -------------------- */
    const MAX_ATTEMPTS = 5, LOCK_MS = 5*60*1000;
    function isLockedOut(){
      const raw = JSON.parse(localStorage.getItem('admin_lock') || '{}');
      return raw.until && Date.now() < raw.until;
    }
    function recordFailedAttempt(){
      const raw = JSON.parse(localStorage.getItem('admin_lock') || '{"fails":0}');
      raw.fails = (raw.fails||0) + 1;
      if(raw.fails >= MAX_ATTEMPTS){
        raw.until = Date.now() + LOCK_MS;
        raw.fails = 0;
      }
      localStorage.setItem('admin_lock', JSON.stringify(raw));
    }
    function resetAttempts(){ localStorage.setItem('admin_lock', JSON.stringify({fails:0,until:0})); }
    function revealAdminLink(show){ const el=document.getElementById('admin-link'); if(el) el.style.display = show ? 'inline-block' : 'none'; }

    function showAdminLoginPrompt(){
      if(isLockedOut()){
        const raw=JSON.parse(localStorage.getItem('admin_lock')||'{}');
        const sLeft=Math.max(1,Math.round((raw.until-Date.now())/1000));
        alert(`Terlalu banyak percobaan. Coba lagi dalam ${sLeft} detik.`); return;
      }
      const p = prompt('Masukkan PIN Admin:');
      if(p===ADMIN_PASSWORD){
        adminUnlocked = true; resetAttempts(); revealAdminLink(true); sessionStorage.setItem('is_admin','1');
        alert('Admin mode aktif.');
      }else{ recordFailedAttempt(); alert('PIN salah.'); }
    }
    function setupSecretOpen(){
      const logo=document.querySelector('.logo');
      let clicks=0,t=null;
      if(logo){
        logo.addEventListener('click', ()=>{
          clicks++; clearTimeout(t); t=setTimeout(()=>{clicks=0;},1000);
          if(clicks>=3){ clicks=0; showAdminLoginPrompt(); }
        });
      }
      document.addEventListener('keydown',(e)=>{ if(e.ctrlKey&&e.altKey&&(e.key==='a'||e.key==='A')) showAdminLoginPrompt(); });
      // restore session
      if(sessionStorage.getItem('is_admin')==='1'){ adminUnlocked=true; revealAdminLink(true); } else { revealAdminLink(false); }
    }
    function requireAdminOrBlock(){
      if(!adminUnlocked){ alert('Khusus Admin.'); throw new Error('admin-only'); }
    }

    /* -------------------- FIREBASE CLOUD SYNC -------------------- */
    const CLOUD = {app:null,db:null,auth:null,ref:null, unsub:null, ro:false, admin:false, ns:'prod'};
    function fbReady(){ return window.firebase && FB_CONFIG && FB_CONFIG.apiKey && FB_CONFIG.apiKey!=='YOUR_API_KEY'; }
    function initFirebase(){
      if(!fbReady()) return false;
      if(!CLOUD.app){
        CLOUD.app = firebase.initializeApp(FB_CONFIG);
        CLOUD.auth = firebase.auth();
        CLOUD.db = firebase.database();
      }
      return true;
    }
    function pathQuestions(){ CLOUD.ns = (byId('fb-namespace')?.value || CLOUD.ns || 'prod'); return 'tt/'+CLOUD.ns+'/questions'; }

    function autoConnectCloudRO(){
      if(!fbReady()) return; // kalau belum isi config, skip saja
      if(!initFirebase()) return;
      // semua user: anonymous auth untuk read (boleh oleh rules .read true atau auth!=null)
      CLOUD.auth.signInAnonymously().catch(()=>{}).finally(()=>{
        CLOUD.ro = true; subscribeQuestions();
      });
    }
    function cloudConnectRO(){
      if(!initFirebase()) return alert('Config Firebase belum diisi.');
      CLOUD.auth.signInAnonymously().then(()=>{ CLOUD.ro=true; subscribeQuestions(); alert('Connected (read-only).'); })
        .catch(e=>alert('Gagal RO: '+e.message));
    }
    function cloudAdminLogin(){
      if(!initFirebase()) return alert('Config Firebase belum diisi.');
      const email = (byId('fb-email').value||'').trim();
      const pass = byId('fb-pass').value||'';
      if(!email||!pass) return alert('Isi email & password admin.');
      CLOUD.auth.signInWithEmailAndPassword(email,pass)
        .then(()=>{ CLOUD.admin=true; CLOUD.ro=true; subscribeQuestions(true); alert('Admin login OK.'); })
        .catch(e=>alert('Login gagal: '+e.message));
    }
    function subscribeQuestions(force=false){
      if(!CLOUD.db) return;
      if(CLOUD.unsub){ CLOUD.ref.off('value', CLOUD.unsub); CLOUD.unsub=null; }
      CLOUD.ref = CLOUD.db.ref( pathQuestions() );
      CLOUD.unsub = CLOUD.ref.on('value', snap=>{
        const data = snap.val();
        if(data && typeof data==='object'){
          // replace penuh (server source of truth), tapi simpan lokal utk offline
          Object.keys(data).forEach(cat=>{
            if(!sampleQuestions[cat]) sampleQuestions[cat]={mudah:[],normal:[],sulit:[]};
            ['mudah','normal','sulit'].forEach(lvl=>{
              sampleQuestions[cat][lvl] = Array.isArray(data[cat][lvl]) ? data[cat][lvl] : [];
            });
          });
          saveToLocalStorage();
          // kalau lagi di Home, biar kategori siap
          if(document.getElementById('home-page').classList.contains('active')) renderCategories();
        }
      });
    }
    function pushToCloudNow(){
      if(!CLOUD.db) return alert('Belum connect Firebase.');
      if(!CLOUD.admin){ /* biar rules yang nolak kalo bukan admin */ }
      const payload = sampleQuestions;
      CLOUD.db.ref( pathQuestions() ).set(payload)
        .then(()=>alert('Push sukses. Semua device akan update realtime.'))
        .catch(e=>alert('Push gagal (cek rules & login admin): '+e.message));
    }
    function pullFromCloudOnce(){
      if(!CLOUD.db) return alert('Belum connect Firebase.');
      CLOUD.db.ref( pathQuestions() ).get()
        .then(snap=>{
          if(!snap.exists()) return alert('Data cloud kosong.');
          const data=snap.val(); applyImport(data,'replace'); saveToLocalStorage();
          alert('Pull sukses (local diganti data cloud).');
        })
        .catch(e=>alert('Pull gagal: '+e.message));
    }

  </script>
</body>
</html>
