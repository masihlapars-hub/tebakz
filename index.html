<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tebak Tebakan - Kuis Seru</title>
  <style>
    :root{
      --primary-color:#4a6fa5;
      --secondary-color:#6b8cbc;
      --accent-color:#ff6b6b;
      --background-color:#f5f7fa;
      --text-color:#333;
      --card-bg:#ffffff;
      --header-bg:#4a6fa5;
      --font-weight:600;
    }
    .theme-dark{
      --primary-color:#2c3e50;
      --secondary-color:#34495e;
      --accent-color:#e74c3c;
      --background-color:#0f172a;
      --text-color:#e2e8f0;
      --card-bg:#111827;
      --header-bg:#1f2937;
    }
    .theme-light-2{--primary-color:#6d4c41;--secondary-color:#8d6e63;--accent-color:#ff5722;--background-color:#f5f5f5;--text-color:#212121;--card-bg:#fff;--header-bg:#6d4c41}
    .theme-light-3{--primary-color:#388e3c;--secondary-color:#4caf50;--accent-color:#ffc107;--background-color:#e8f5e9;--text-color:#1b5e20;--card-bg:#fff;--header-bg:#388e3c}
    .theme-light-4{--primary-color:#1976d2;--secondary-color:#2196f3;--accent-color:#ff5252;--background-color:#e3f2fd;--text-color:#0d47a1;--card-bg:#fff;--header-bg:#1976d2}
    .theme-dark-2{--primary-color:#7b1fa2;--secondary-color:#9c27b0;--accent-color:#ff4081;--background-color:#0b1020;--text-color:#e1bee7;--card-bg:#151a30;--header-bg:#7b1fa2}
    .theme-dark-3{--primary-color:#d32f2f;--secondary-color:#f44336;--accent-color:#ff9800;--background-color:#101010;--text-color:#ffcdd2;--card-bg:#1d1d1d;--header-bg:#d32f2f}
    .theme-dark-4{--primary-color:#00796b;--secondary-color:#009688;--accent-color:#ffeb3b;--background-color:#0f1a1a;--text-color:#b2dfdb;--card-bg:#0d2525;--header-bg:#00796b}

    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    body{background:var(--background-color);color:var(--text-color);font-weight:var(--font-weight);transition:.3s}
    header{background:var(--header-bg);color:#fff}
    nav{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:14px 20px}
    .logo{font-size:1.4rem;font-weight:800}
    .nav-links{display:flex;gap:16px}
    .nav-links a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:6px}
    .nav-links a:hover{background:rgba(255,255,255,.12)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .page{display:none;min-height:80vh}
    .page.active{display:block}
    .card{background:var(--card-bg);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.12);padding:22px;margin:14px 0}
    .btn{background:var(--primary-color);color:#fff;border:0;padding:10px 18px;border-radius:10px;cursor:pointer;font-weight:800}
    .btn:hover{filter:brightness(.95)}
    .btn-sm{padding:8px 14px;font-size:.92rem;margin:4px}

    .login-container{display:flex;flex-direction:column;align-items:center;gap:16px}
    .avatar-selection,.theme-selection{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .avatar-option{width:78px;height:78px;border-radius:50%;object-fit:cover;cursor:pointer;border:3px solid transparent;transition:.2s;background:#eee;display:block}
    .avatar-option.selected{border-color:var(--primary-color);transform:scale(1.06)}
    .theme-option{padding:8px 14px;border:2px solid var(--primary-color);border-radius:10px;cursor:pointer}
    .theme-option.selected{background:var(--primary-color);color:#fff}

    .category-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .category-item{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);padding:16px;text-align:center}
    .level-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}

    .question-image{max-width:100%;max-height:260px;border-radius:8px;margin:12px 0}
    .options-container{display:flex;flex-direction:column;gap:10px}
    .option{padding:14px;border:2px solid #cbd5e1;border-radius:10px;cursor:pointer}
    .option.selected{background:var(--secondary-color);color:#fff;border-color:var(--primary-color)}
    .progress-bar{height:10px;background:#e2e8f0;border-radius:8px;margin:10px 0;overflow:hidden}
    .progress{height:100%;background:var(--primary-color);width:0%}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#eef2ff}

    .bank{margin-top:10px;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
    .bank > div{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid #e5e7eb}
    .bank .q{flex:1}
    .bank button{white-space:nowrap}
    @media(max-width:768px){.category-grid{grid-template-columns:1fr}}
  </style>
</head>
<body class="theme-light">
  <header>
    <nav>
      <div class="logo">Tebak Tebakan</div>
      <div class="nav-links">
        <a href="#" id="home-link">Home</a>
        <a href="#" id="score-link">Top Score</a>
        <a href="#" id="admin-link">Admin</a>
        <a href="#" id="logout-link">Logout</a>
      </div>
    </nav>
  </header>

  <div class="container">
    <!-- Login -->
    <div id="login-page" class="page active">
      <div class="card">
        <div class="login-container">
          <h2>Login Pemain</h2>
          <div style="width:100%;max-width:520px">
            <label for="player-name" style="display:block;margin:6px 0;font-weight:800">Nama Pemain</label>
            <input id="player-name" type="text" placeholder="Masukkan nama Anda" style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:10px;background:var(--card-bg);color:var(--text-color)"/>
          </div>

          <h3>Pilih Avatar</h3>
          <div id="avatar-selection" class="avatar-selection"></div>

          <h3>Pilih Tema</h3>
          <div id="theme-selection" class="theme-selection"></div>

          <button id="start-game-btn" class="btn">Mulai Bermain</button>
        </div>
      </div>
    </div>

    <!-- Home -->
    <div id="home-page" class="page">
      <div class="card">
        <h2>Selamat Datang, <span id="player-greeting">Pemain</span>!</h2>
        <p>Pilih kategori dan tingkat kesulitan untuk mulai bermain.</p>
      </div>
      <div id="category-grid" class="category-grid"></div>
    </div>

    <!-- Top Score -->
    <div id="score-page" class="page">
      <div class="card">
        <h2>Top Score</h2>
        <p id="score-empty" style="display:none;margin:8px 0">Belum ada skor. Main dulu ya!</p>
        <div style="overflow:auto">
          <table id="score-table" aria-label="Top Score">
            <thead>
              <tr>
                <th>#</th><th>Nama</th><th>Skor</th><th>Benar/Total</th><th>Kategori</th><th>Level</th><th>Durasi</th><th>Tanggal</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Quiz -->
    <div id="quiz-page" class="page">
      <div class="card">
        <div class="quiz-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2 id="quiz-category">Kategori:</h2>
          <div class="quiz-info" style="display:flex;gap:12px">
            <span id="quiz-level">Level:</span>
            <span id="question-number">Soal 1/1</span>
          </div>
        </div>
        <div class="progress-bar"><div id="quiz-progress" class="progress"></div></div>
        <div class="question-container">
          <h3 id="question-text">Pertanyaan…</h3>
          <img id="question-image" class="question-image" style="display:none" alt="Gambar Soal"/>
        </div>
        <div id="options-container" class="options-container"></div>
        <button id="next-question-btn" class="btn" style="margin-top:14px">Selanjutnya</button>
      </div>
    </div>

    <!-- Result -->
    <div id="result-page" class="page">
      <div class="card">
        <h2>Hasil Kuis</h2>
        <p id="score-display">Skor Anda: 0/0</p>
        <h3 style="margin:10px 0">Detail Jawaban</h3>
        <div id="answer-details"></div>
        <button id="back-to-home-btn" class="btn" style="margin-top:14px">Kembali ke Home</button>
      </div>
    </div>

    <!-- Admin -->
    <div id="admin-page" class="page">
      <div class="card"><h2>Panel Admin</h2><p>Tambah + hapus soal (tersimpan di LocalStorage)</p></div>

      <div class="card">
        <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))">
          <div>
            <label>Kategori</label>
            <select id="question-category" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px"></select>
          </div>
          <div>
            <label>Level</label>
            <select id="question-level" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
              <option value="mudah">Mudah</option>
              <option value="normal">Normal</option>
              <option value="sulit">Sulit</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label>Pertanyaan</label>
            <textarea id="question-text" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px"></textarea>
          </div>
          <div><label>Opsi A</label><input id="option-a" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px"></div>
          <div><label>Opsi B</label><input id="option-b" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px"></div>
          <div><label>Opsi C</label><input id="option-c" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px"></div>
          <div><label>Opsi D</label><input id="option-d" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px"></div>
          <div>
            <label>Jawaban Benar</label>
            <select id="correct-answer" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
              <option value="a">A</option><option value="b">B</option>
              <option value="c">C</option><option value="d">D</option>
            </select>
          </div>
          <div>
            <label>URL Gambar (opsional)</label>
            <input id="question-image-url" placeholder="https://..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="add-question-btn" class="btn">Tambah Soal</button>
          <button id="clear-scores-btn" class="btn" title="Hapus seluruh top score">Reset Top Score</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:10px">Bank Soal (Kategori/Level terpilih)</h3>
        <div id="bank-wrap" class="bank"></div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Error overlay ---------- */
    window.onerror = function(msg, src, line, col){
      const b = document.createElement('div');
      b.style.cssText='position:fixed;left:0;right:0;top:0;z-index:99999;background:#ffdddd;color:#900;padding:8px;font:12px monospace';
      b.textContent='JS ERROR: '+msg+' @ '+line+':'+col;
      document.body.appendChild(b);
    };

    /* -------------------- STATE -------------------- */
    const ADMIN_PASSWORD = '281105';
    let adminUnlocked = false;

    // Nama file avatar sesuai punyamu
    const AVATAR_FILES = [
      '3f983b9ca5618e87e3734751e643c00a.jpg',
      '23f038cc913bb02b9b58bc7d8418dd6d.jpg',
      '41bb3d263d7697d065daef857a33bad9.jpg',
      'adad96e29d8f85ab783efedc4bf77339.jpg',
      'b4be2a5c52b166134c6a6b219836dcb1.jpg',
      '4e339904b7614b9f80ba2d1f65c62ea1.jpg',
      'c69a2653915d4f413e5450f1a87a2bc5.jpg',
      'be6f89e2633168738acf2deb817cfeb6.jpg',
      'a975a06b73c871fd961c088eb19ed64a (1).jpg'
    ];

    const PLACEHOLDER = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect rx='80' ry='80' width='160' height='160' fill='%23e2e8f0'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%236b7280'>avatar missing</text></svg>";

    // Dir index.html (mis. /tebakz/) → avatar di /tebakz/static/avatars/
    const REPO_DIR = (function(){
      const p = location.pathname;
      return p.endsWith('/') ? p : p.replace(/\/[^\/]*$/, '/');
    })();
    const AVATAR_DIR = REPO_DIR + 'static/avatars/';
    const AVATAR_URLS = AVATAR_FILES.map(fn => AVATAR_DIR + encodeURIComponent(fn));

    const appData = {
      currentPlayer:{name:'Pemain',avatar:AVATAR_URLS[0],theme:'theme-light',score:0},
      currentQuestions:[],
      currentQuestionIndex:0,
      userAnswers:[],
      currentCategory:'',
      currentLevel:'',
      quizStartAt:0,
      scores:[],
      categories:[
        {id:'ipa',name:'IPA',description:'Ilmu Pengetahuan Alam'},
        {id:'ips',name:'IPS',description:'Ilmu Pengetahuan Sosial'},
        {id:'utbk',name:'UTBK',description:'Ujian Tulis Berbasis Komputer'},
        {id:'agama',name:'Agama',description:'Pendidikan Agama'},
        {id:'tebak-receh',name:'Tebak Receh',description:'Tebakan Receh'},
        {id:'cpns',name:'CPNS',description:'Tes CPNS'},
        {id:'logika',name:'Logika',description:'Tes Logika'},
        {id:'mtk',name:'MTK',description:'Tes Matematika'},
        {id:'it',name:'IT',description:'Soal IT'}
      ],
      avatars: AVATAR_URLS,
      themes:[
        {id:'theme-light-1',name:'Terang 1',class:'theme-light'},
        {id:'theme-dark-1',name:'Gelap 1',class:'theme-dark'},
        {id:'theme-light-2',name:'Terang 2',class:'theme-light-2'},
        {id:'theme-light-3',name:'Terang 3',class:'theme-light-3'},
        {id:'theme-light-4',name:'Terang 4',class:'theme-light-4'},
        {id:'theme-dark-2',name:'Gelap 2',class:'theme-dark-2'},
        {id:'theme-dark-3',name:'Gelap 3',class:'theme-dark-3'},
        {id:'theme-dark-4',name:'Gelap 4',class:'theme-dark-4'}
      ]
    };

    /* -------------------- SOAL AWAL CONTOH -------------------- */
    const sampleQuestions = {
      ipa:{
        mudah:[
          {id:1,question:'Planet terdekat dari matahari?',options:{a:'Venus',b:'Bumi',c:'Mars',d:'Merkurius'},correctAnswer:'d',image:''},
          {id:2,question:'Fungsi mitokondria?',options:{a:'Fotosintesis',b:'Pembangkit energi sel',c:'Kontrol aktivitas sel',d:'Sintesis protein'},correctAnswer:'b',image:''}
        ],
        normal:[],sulit:[]
      },
      it:{
        mudah:[
          {id:1,question:'HTML kepanjangannya?',options:{a:'Hyperlinks and Text Markup Language',b:'HyperText Markup Language',c:'Home Tool Markup Language',d:'Hyper Text Makeup Language'},correctAnswer:'b',image:''}
        ],
        normal:[],sulit:[]
      }
    };

    /* -------------------- INIT -------------------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      setupEventListeners();
      loadFromLocalStorage();

      renderAvatarOptions();
      renderThemeOptions();
      renderCategories();
      renderCategoryOptionsForAdmin();
      renderBank();
    });

    function setupEventListeners(){
      document.getElementById('home-link').addEventListener('click',()=>{ showPage('home-page'); });
      document.getElementById('score-link').addEventListener('click',()=>{ renderTopScores(); showPage('score-page'); });

      document.getElementById('admin-link').addEventListener('click',()=>{
        if(!adminUnlocked){
          const p = prompt('Masukkan password Admin:');
          if(p===ADMIN_PASSWORD){ adminUnlocked=true; alert('Akses Admin dibuka.'); }
          else { alert('Password salah.'); return; }
        }
        showPage('admin-page');
        renderBank();
      });

      document.getElementById('logout-link').addEventListener('click',logout);

      document.getElementById('start-game-btn').addEventListener('click',startGame);
      document.getElementById('next-question-btn').addEventListener('click',handleNextQuestion);
      document.getElementById('back-to-home-btn').addEventListener('click',()=>showPage('home-page'));
      document.getElementById('clear-scores-btn').addEventListener('click',()=>{
        if(confirm('Hapus semua top score?')){ appData.scores=[]; saveToLocalStorage(); renderTopScores(); alert('Top score direset.'); }
      });

      document.addEventListener('click',e=>{
        if(e.target.classList.contains('option')){
          document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
          e.target.classList.add('selected');
          appData.userAnswers[appData.currentQuestionIndex]=e.target.dataset.option;
        }
      });

      document.getElementById('add-question-btn').addEventListener('click',addQuestion);
      document.getElementById('question-category').addEventListener('change',renderBank);
      document.getElementById('question-level').addEventListener('change',renderBank);
    }

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    /* -------------------- LOGIN & HOME -------------------- */
    function renderAvatarOptions(){
      const c=document.getElementById('avatar-selection');
      c.innerHTML='';
      appData.avatars.forEach((fullSrc,idx)=>{
        const img=document.createElement('img');
        img.src=fullSrc; img.alt='Avatar '+(idx+1);
        img.className='avatar-option';
        img.onerror = ()=>{ img.src=PLACEHOLDER; img.title='Tidak ditemukan: '+decodeURIComponent(fullSrc); };
        if((idx===0 && !appData.currentPlayer.avatar) || appData.currentPlayer.avatar===fullSrc){
          appData.currentPlayer.avatar=fullSrc;
          img.classList.add('selected');
        }
        img.addEventListener('click',()=>{
          document.querySelectorAll('.avatar-option').forEach(i=>i.classList.remove('selected'));
          img.classList.add('selected');
          appData.currentPlayer.avatar=fullSrc;
          saveToLocalStorage();
        });
        c.appendChild(img);
      });
    }

    function renderThemeOptions(){
      const c=document.getElementById('theme-selection');
      c.innerHTML='';
      appData.themes.forEach((t)=>{
        const el=document.createElement('div');
        el.textContent=t.name;
        el.className='theme-option';
        if(appData.currentPlayer.theme===t.class || (!appData.currentPlayer.theme && t.class==='theme-light')){
          el.classList.add('selected');
          document.body.classList.add(t.class);
        }
        el.addEventListener('click',()=>{
          document.querySelectorAll('.theme-option').forEach(i=>i.classList.remove('selected'));
          el.classList.add('selected');
          document.body.classList.remove(...appData.themes.map(x=>x.class));
          document.body.classList.add(t.class);
          appData.currentPlayer.theme=t.class;
          saveToLocalStorage();
        });
        c.appendChild(el);
      });
    }

    function renderCategories(){
      const grid=document.getElementById('category-grid');
      grid.innerHTML='';
      appData.categories.forEach(cat=>{
        const box=document.createElement('div');
        box.className='category-item';
        box.innerHTML = `
          <h3>${cat.name}</h3>
          <p>${cat.description||''}</p>
          <div class="level-buttons">
            <button class="btn btn-sm" data-category="${cat.id}" data-level="mudah">Mudah</button>
            <button class="btn btn-sm" data-category="${cat.id}" data-level="normal">Normal</button>
            <button class="btn btn-sm" data-category="${cat.id}" data-level="sulit">Sulit</button>
          </div>`;
        grid.appendChild(box);
        box.querySelectorAll('.level-buttons button').forEach(b=>{
          b.addEventListener('click',()=>startQuiz(b.dataset.category,b.dataset.level));
        });
      });
    }

    function startGame(){
      const name = (document.getElementById('player-name').value||'').trim();
      if(!name){ alert('Silakan isi nama dulu ya.'); return; }
      appData.currentPlayer.name=name;
      document.getElementById('player-greeting').textContent=name;
      saveToLocalStorage();
      showPage('home-page');
    }

    /* -------------------- QUIZ -------------------- */
    function startQuiz(category,level){
      appData.currentCategory=category;
      appData.currentLevel=level;
      appData.currentQuestionIndex=0;
      appData.userAnswers=[];
      appData.quizStartAt=Date.now();

      let qs=[];
      if(sampleQuestions[category] && sampleQuestions[category][level] && sampleQuestions[category][level].length){
        qs=sampleQuestions[category][level];
      }else{
        qs=[{id:1,question:`Contoh soal ${category} (${level})`,options:{a:'Opsi A',b:'Opsi B',c:'Opsi C',d:'Opsi D'},correctAnswer:'a',image:''}];
      }
      appData.currentQuestions=qs;

      document.getElementById('quiz-category').textContent='Kategori: '+category.toUpperCase();
      document.getElementById('quiz-level').textContent='Level: '+level;
      showPage('quiz-page');
      showQuestion(0);
    }

    function showQuestion(i){
      if(i>=appData.currentQuestions.length){ finishQuiz(); return; }
      const q=appData.currentQuestions[i];
      document.getElementById('question-text').textContent=q.question;
      document.getElementById('question-number').textContent=`Soal ${i+1}/${appData.currentQuestions.length}`;

      const qi=document.getElementById('question-image');
      if(q.image){ qi.src=q.image; qi.style.display='block'; }
      else { qi.style.display='none'; }

      document.getElementById('quiz-progress').style.width = (i/appData.currentQuestions.length*100)+'%';

      const oc=document.getElementById('options-container'); oc.innerHTML='';
      Object.entries(q.options).forEach(([k,v])=>{
        const d=document.createElement('div');
        d.className='option'; d.dataset.option=k; d.innerHTML=`<strong>${k.toUpperCase()}.</strong> ${v}`;
        if(appData.userAnswers[i]===k) d.classList.add('selected');
        oc.appendChild(d);
      });
    }

    function handleNextQuestion(){
      if(!appData.userAnswers[appData.currentQuestionIndex]){
        alert('Pilih jawaban dulu ya!');
        return;
      }
      appData.currentQuestionIndex++;
      showQuestion(appData.currentQuestionIndex);
    }

    function finishQuiz(){
      let score=0; const details=[];
      appData.currentQuestions.forEach((q,idx)=>{
        const ua=appData.userAnswers[idx];
        const ok=ua===q.correctAnswer;
        if(ok) score++;
        details.push({q:q.question,u:ua?q.options[ua]:'Tidak dijawab',c:q.options[q.correctAnswer],ok});
      });
      appData.currentPlayer.score=score;

      document.getElementById('score-display').textContent=`Skor Anda: ${score}/${appData.currentQuestions.length}`;
      const wrap=document.getElementById('answer-details'); wrap.innerHTML='';
      details.forEach((d,i)=>{
        const e=document.createElement('div');
        e.style.cssText=`margin:10px 0;padding:10px;border-left:4px solid ${d.ok?'#4caf50':'#f44336'};background:${d.ok?'#e8f5e9':'#ffebee'};border-radius:6px`;
        e.innerHTML=`<p><strong>Soal ${i+1}:</strong> ${d.q}</p><p><strong>Jawaban Anda:</strong> ${d.u}</p><p><strong>Jawaban Benar:</strong> ${d.c}</p>`;
        wrap.appendChild(e);
      });

      const ms = Math.max(1, Date.now()-appData.quizStartAt);
      addScore({ name: appData.currentPlayer.name || 'Pemain', score,
                 total: appData.currentQuestions.length, category: appData.currentCategory,
                 level: appData.currentLevel, ms, date: new Date().toISOString() });

      showPage('result-page');
      saveToLocalStorage();
    }

    /* -------------------- TOP SCORE -------------------- */
    function addScore(rec){
      appData.scores.push(rec);
      appData.scores.sort((a,b)=>{
        if(b.score!==a.score) return b.score-a.score;
        if(a.ms!==b.ms) return a.ms-b.ms;
        return new Date(a.date)-new Date(b.date);
      });
      appData.scores = appData.scores.slice(0,100);
      saveToLocalStorage();
    }

    function renderTopScores(){
      const tbody = document.querySelector('#score-table tbody');
      const empty = document.getElementById('score-empty');
      tbody.innerHTML='';
      if(!appData.scores.length){ empty.style.display='block'; return; }
      empty.style.display='none';
      appData.scores.forEach((s,idx)=>{
        const tr=document.createElement('tr');
        const dur = Math.round(s.ms/1000)+' dtk';
        const tgl = new Date(s.date).toLocaleString('id-ID');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHTML(s.name)}</td>
          <td>${s.score}</td>
          <td>${s.score}/${s.total}</td>
          <td>${s.category.toUpperCase()}</td>
          <td>${s.level}</td>
          <td>${dur}</td>
          <td>${tgl}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* -------------------- ADMIN -------------------- */
    function renderCategoryOptionsForAdmin(){
      const sel=document.getElementById('question-category'); sel.innerHTML='';
      appData.categories.forEach(c=>{
        const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o);
      });
    }
    function ensureCategory(cat){
      if(!sampleQuestions[cat]) sampleQuestions[cat]={mudah:[],normal:[],sulit:[]};
      ['mudah','normal','sulit'].forEach(lv=>{ if(!Array.isArray(sampleQuestions[cat][lv])) sampleQuestions[cat][lv]=[]; });
    }
    function getCurrentCatLvl(){ return {cat:document.getElementById('question-category').value,lvl:document.getElementById('question-level').value}; }

    function addQuestion(){
      const {cat,lvl} = getCurrentCatLvl();
      const qt = (document.getElementById('question-text').value||'').trim();
      const a  = (document.getElementById('option-a').value||'').trim();
      const b  = (document.getElementById('option-b').value||'').trim();
      const c  = (document.getElementById('option-c').value||'').trim();
      const d  = (document.getElementById('option-d').value||'').trim();
      const correct = document.getElementById('correct-answer').value;
      const image = (document.getElementById('question-image-url').value||'').trim();

      if(!qt||!a||!b||!c||!d){ alert('Pertanyaan & semua opsi (A–D) wajib diisi.'); return; }
      ensureCategory(cat);
      sampleQuestions[cat][lvl].push({id:Date.now(),question:qt,options:{a,b,c,d},correctAnswer:correct,image});

      // reset
      document.getElementById('question-text').value='';
      document.getElementById('option-a').value='';
      document.getElementById('option-b').value='';
      document.getElementById('option-c').value='';
      document.getElementById('option-d').value='';
      document.getElementById('question-image-url').value='';

      saveToLocalStorage();
      renderBank();
      alert('Soal ditambahkan!');
    }

    function renderBank(){
      const {cat,lvl} = getCurrentCatLvl();
      ensureCategory(cat);
      const wrap = document.getElementById('bank-wrap');
      wrap.innerHTML='';
      const list = sampleQuestions[cat][lvl];
      if(!list.length){ wrap.innerHTML = "<div style='padding:14px'>Belum ada soal pada kategori ini.</div>"; return; }
      list.forEach((q,idx)=>{
        const row = document.createElement('div');
        row.innerHTML = `
          <div class="q"><strong>${idx+1}.</strong> ${escapeHTML(q.question)}</div>
          <button class="btn btn-sm" data-act="del" data-id="${q.id}">Hapus</button>`;
        wrap.appendChild(row);
      });
      wrap.querySelectorAll('button[data-act="del"]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = Number(btn.dataset.id);
          const arr = sampleQuestions[cat][lvl];
          const pos = arr.findIndex(x=>x.id===id);
          if(pos>-1 && confirm('Hapus soal ini?')){ arr.splice(pos,1); saveToLocalStorage(); renderBank(); }
        };
      });
    }

    /* -------------------- STORAGE -------------------- */
    function saveToLocalStorage(){
      const data = {
        categories: appData.categories,
        questions: sampleQuestions,
        player: appData.currentPlayer,
        scores: appData.scores
      };
      localStorage.setItem('tebakTebakanData', JSON.stringify(data));
    }
    function loadFromLocalStorage(){
      const raw=localStorage.getItem('tebakTebakanData'); if(!raw) return;
      try{
        const data=JSON.parse(raw);
        if(data.categories) appData.categories=data.categories;
        if(data.questions) Object.assign(sampleQuestions, data.questions);
        if(Array.isArray(data.scores)) appData.scores = data.scores;
        if(data.player){
          appData.currentPlayer=data.player;
          document.getElementById('player-name').value=appData.currentPlayer.name||'';
          document.getElementById('player-greeting').textContent=appData.currentPlayer.name||'Pemain';
          if(appData.currentPlayer.theme){
            document.body.classList.remove(...appData.themes.map(t=>t.class));
            document.body.classList.add(appData.currentPlayer.theme);
          }
        }
      }catch(e){ console.warn('Parse localStorage gagal:', e); }
    }

    function logout(){
      if(!confirm('Yakin ingin logout?')) return;
      appData.currentPlayer={name:'Pemain',avatar:AVATAR_URLS[0],theme:'theme-light',score:0};
      saveToLocalStorage();
      showPage('login-page');
      renderAvatarOptions();
      renderThemeOptions();
    }

    /* -------------------- UTIL -------------------- */
    function escapeHTML(s=''){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
  </script>
</body>
</html>
