<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tebak Tebakan - Kuis Seru</title>
  <style>
    :root{
      --primary-color:#4a6fa5;
      --secondary-color:#6b8cbc;
      --accent-color:#ff6b6b;
      --background-color:#f5f7fa;
      --text-color:#333;
      --card-bg:#ffffff;
      --header-bg:#4a6fa5;
      --font-weight:bold;
    }
    .theme-dark{
      --primary-color:#2c3e50;
      --secondary-color:#34495e;
      --accent-color:#e74c3c;
      --background-color:#1a1a2e;
      --text-color:#ecf0f1;
      --card-bg:#16213e;
      --header-bg:#2c3e50;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:var(--background-color);color:var(--text-color);font-weight:var(--font-weight);transition:.3s}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:var(--header-bg);color:#fff;padding:15px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    nav{display:flex;justify-content:space-between;align-items:center;padding:0 20px}
    .logo{font-size:1.5rem;font-weight:bold}
    .nav-links{display:flex;gap:16px}
    .nav-links a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:4px}
    .nav-links a:hover{background:var(--secondary-color)}

    .page{display:none;min-height:80vh;padding:20px}
    .page.active{display:block}
    .card{background:var(--card-bg);border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1);padding:20px;margin-bottom:20px}
    .btn{background:var(--primary-color);color:#fff;border:0;padding:10px 18px;border-radius:6px;cursor:pointer;font-weight:bold}
    .btn:hover{background:var(--secondary-color)}
    .btn-sm{padding:8px 14px;font-size:.9rem;margin:4px}

    .login-container{display:flex;flex-direction:column;align-items:center;min-height:60vh;gap:14px}
    .avatar-selection,.theme-selection{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .avatar-option{width:72px;height:72px;border-radius:50%;object-fit:cover;cursor:pointer;border:3px solid transparent;transition:.2s}
    .avatar-option.selected{border-color:var(--primary-color);transform:scale(1.06)}
    .theme-option{padding:8px 14px;border:2px solid var(--primary-color);border-radius:6px;cursor:pointer}
    .theme-option.selected{background:var(--primary-color);color:#fff}

    .category-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:10px}
    .category-item{background:var(--card-bg);border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.08);padding:16px;text-align:center}
    .category-image{width:96px;height:96px;object-fit:cover;border-radius:10px;margin-bottom:8px}
    .level-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}

    .question-image{max-width:100%;max-height:280px;border-radius:8px;margin:12px 0}
    .options-container{display:flex;flex-direction:column;gap:10px}
    .option{padding:14px;border:2px solid #ddd;border-radius:8px;cursor:pointer}
    .option.selected{background:var(--secondary-color);color:#fff;border-color:var(--primary-color)}
    .progress-bar{height:10px;background:#eee;border-radius:6px;margin:10px 0;overflow:hidden}
    .progress{height:100%;background:var(--primary-color);width:0%}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#eef2ff}

    @media(max-width:768px){
      .category-grid{grid-template-columns:1fr}
      .question-image{max-height:200px}
    }
  </style>
</head>
<body class="theme-light">
  <header>
    <nav>
      <div class="logo">Tebak Tebakan</div>
      <div class="nav-links">
        <a href="#" id="home-link">Home</a>
        <a href="#" id="score-link">Top Score</a>
        <a href="#" id="admin-link">Admin</a>
        <a href="#" id="logout-link">Logout</a>
      </div>
    </nav>
  </header>

  <div class="container">
    <!-- Login -->
    <div id="login-page" class="page active">
      <div class="card">
        <div class="login-container">
          <h2>Login Pemain</h2>
          <div style="width:100%;max-width:520px">
            <label for="player-name" style="display:block;margin:6px 0;font-weight:bold">Nama Pemain</label>
            <input id="player-name" type="text" placeholder="Masukkan nama Anda" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;background:var(--card-bg);color:var(--text-color)"/>
          </div>

          <h3>Pilih Avatar</h3>
          <div id="avatar-selection" class="avatar-selection"></div>

          <h3>Pilih Tema</h3>
          <div id="theme-selection" class="theme-selection"></div>

          <button id="start-game-btn" class="btn">Mulai Bermain</button>
        </div>
      </div>
    </div>

    <!-- Home -->
    <div id="home-page" class="page">
      <div class="card">
        <h2>Selamat Datang, <span id="player-greeting">Pemain</span>!</h2>
        <p>Pilih kategori dan tingkat kesulitan untuk mulai bermain.</p>
      </div>
      <div id="category-grid" class="category-grid"></div>
    </div>

    <!-- Top Score -->
    <div id="score-page" class="page">
      <div class="card">
        <h2>Top Score</h2>
        <p id="score-empty" style="display:none;margin:8px 0">Belum ada skor. Main dulu ya!</p>
        <div style="overflow:auto">
          <table id="score-table" aria-label="Top Score">
            <thead>
              <tr>
                <th>#</th>
                <th>Nama</th>
                <th>Skor</th>
                <th>Benar/Total</th>
                <th>Kategori</th>
                <th>Level</th>
                <th>Durasi</th>
                <th>Tanggal</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Quiz -->
    <div id="quiz-page" class="page">
      <div class="card">
        <div class="quiz-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2 id="quiz-category">Kategori:</h2>
          <div class="quiz-info" style="display:flex;gap:12px">
            <span id="quiz-level">Level:</span>
            <span id="question-number">Soal 1/1</span>
          </div>
        </div>
        <div class="progress-bar"><div id="quiz-progress" class="progress"></div></div>
        <div class="question-container">
          <h3 id="question-text">Pertanyaan…</h3>
          <img id="question-image" class="question-image" style="display:none" alt="Gambar Soal"/>
        </div>
        <div id="options-container" class="options-container"></div>
        <button id="next-question-btn" class="btn" style="margin-top:14px">Selanjutnya</button>
      </div>
    </div>

    <!-- Result -->
    <div id="result-page" class="page">
      <div class="card">
        <h2>Hasil Kuis</h2>
        <p id="score-display">Skor Anda: 0/0</p>
        <h3 style="margin:10px 0">Detail Jawaban</h3>
        <div id="answer-details"></div>
        <button id="back-to-home-btn" class="btn" style="margin-top:14px">Kembali ke Home</button>
      </div>
    </div>

    <!-- Admin -->
    <div id="admin-page" class="page">
      <div class="card"><h2>Panel Admin</h2><p>Tambah soal + kelola bank soal</p></div>
      <div class="card">
        <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))">
          <div>
            <label>Kategori</label>
            <select id="question-category" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></select>
          </div>
          <div>
            <label>Level</label>
            <select id="question-level" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
              <option value="mudah">Mudah</option>
              <option value="normal" selected>Normal</option>
              <option value="sulit">Sulit</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label>Pertanyaan</label>
            <textarea id="question-text" rows="3" placeholder="Tulis pertanyaan…" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></textarea>
          </div>
          <div><label>Opsi A</label><input id="option-a" placeholder="Teks opsi A" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>
          <div><label>Opsi B</label><input id="option-b" placeholder="Teks opsi B" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>
          <div><label>Opsi C</label><input id="option-c" placeholder="Teks opsi C" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>
          <div><label>Opsi D</label><input id="option-d" placeholder="Teks opsi D" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>
          <div style="grid-column:1/-1">
            <label>URL Gambar (opsional)</label>
            <input id="admin-image-url" placeholder="https://…/gambar.jpg" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
          </div>
          <div>
            <label>Jawaban Benar</label>
            <select id="correct-answer" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
              <option value="a">A</option><option value="b">B</option>
              <option value="c" selected>C</option><option value="d">D</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="add-question-btn" class="btn">Tambah Soal</button>
          <button id="clear-scores-btn" class="btn" title="Hapus seluruh top score">Reset Top Score</button>
          <button id="export-questions-btn" class="btn">Ekspor Soal</button>
          <button id="import-questions-btn" class="btn">Impor Soal (Paste)</button>
          <button id="import-file-btn" class="btn">Impor dari File</button>
        </div>
        <textarea id="import-json" placeholder="Paste JSON bank soal di sini lalu klik 'Impor Soal (Paste)' lagi"
          style="display:none;width:100%;margin-top:10px;height:140px"></textarea>
        <input type="file" id="import-file" accept="application/json" style="display:none">
      </div>
    </div>
  </div>

  <script>
    /* ---------- Error overlay ---------- */
    window.onerror = function(msg, src, line, col){
      const b = document.createElement('div');
      b.style.cssText='position:fixed;left:0;right:0;top:0;z-index:99999;background:#ffdddd;color:#900;padding:8px;font:12px monospace';
      b.textContent='JS ERROR: '+msg+' @ '+line+':'+col;
      document.body.appendChild(b);
    };

    /* -------------------- STATE DASAR -------------------- */
    const ADMIN_PASSWORD = '281105';
    let adminUnlocked = false;

    const appData = {
      currentPlayer:{name:'Pemain',avatar:'',theme:'theme-light',score:0},
      currentQuestions:[],
      currentQuestionIndex:0,
      userAnswers:[],
      currentCategory:'',
      currentLevel:'',
      quizStartAt:0,
      scores:[],
      categories:[
        {id:'ipa',name:'IPA',description:'Ilmu Pengetahuan Alam',image:''},
        {id:'ips',name:'IPS',description:'Ilmu Pengetahuan Sosial',image:''},
        {id:'utbk',name:'UTBK',description:'Ujian Tulis Berbasis Komputer',image:''},
        {id:'agama',name:'Agama',description:'Pendidikan Agama',image:''},
        {id:'tebak-receh',name:'Tebak Receh',description:'Tebakan Receh',image:''},
        {id:'cpns',name:'CPNS',description:'Tes CPNS',image:''},
        {id:'logika',name:'Logika',description:'Tes Logika',image:''},
        {id:'mtk',name:'MTK',description:'Tes Matematika',image:''},
        {id:'it',name:'IT',description:'Soal IT',image:''}
      ],
      avatars:[
        'https://picsum.photos/seed/a/128','https://picsum.photos/seed/b/128',
        'https://picsum.photos/seed/c/128','https://picsum.photos/seed/d/128'
      ],
      themes:[
        {id:'theme-light-1',name:'Terang 1',class:'theme-light'},
        {id:'theme-dark-1',name:'Gelap 1',class:'theme-dark'}
      ]
    };

    /* -------------------- BANK SOAL -------------------- */
    const sampleQuestions = {
      ipa:{
        mudah:[
          {id:1,question:'Planet terdekat dari matahari?',options:{a:'Venus',b:'Bumi',c:'Mars',d:'Merkurius'},correctAnswer:'d',image:''},
          {id:2,question:'Fungsi mitokondria?',options:{a:'Fotosintesis',b:'Pembangkit energi sel',c:'Kontrol aktivitas sel',d:'Sintesis protein'},correctAnswer:'b',image:''}
        ],
        normal:[
          {id:101,question:'Bunyi tidak dapat merambat melalui…',options:{a:'benda padat',b:'ruang hampa',c:'air',d:'udara'},correctAnswer:'b',image:''}
        ],
        sulit:[]
      },
      it:{
        mudah:[
          {id:1,question:'HTML kepanjangannya?',options:{a:'Hyperlinks and Text Markup Language',b:'HyperText Markup Language',c:'Home Tool Markup Language',d:'Hyper Text Makeup Language'},correctAnswer:'b',image:''}
        ],
        normal:[],sulit:[]
      }
    };

    /* -------------------- INISIALISASI -------------------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      setupEventListeners();
      setupAdditionalThemes();
      loadFromLocalStorage();

      renderAvatarOptions();
      renderThemeOptions();
      renderCategories();
      renderCategoryOptionsForAdmin();
    });

    function setupAdditionalThemes(){
      const style=document.createElement('style');
      style.textContent=`
        .theme-light-2{--primary-color:#6d4c41;--secondary-color:#8d6e63;--accent-color:#ff5722;--background-color:#f5f5f5;--text-color:#212121;--card-bg:#fff;--header-bg:#6d4c41}
        .theme-dark-2{--primary-color:#7b1fa2;--secondary-color:#9c27b0;--accent-color:#ff4081;--background-color:#1a1a1a;--text-color:#e1bee7;--card-bg:#2d2d2d;--header-bg:#7b1fa2}
      `;
      document.head.appendChild(style);

      appData.themes.push(
        {id:'theme-light-2',name:'Terang 2',class:'theme-light-2'},
        {id:'theme-dark-2',name:'Gelap 2',class:'theme-dark-2'}
      );
    }

    function setupEventListeners(){
      document.getElementById('home-link').addEventListener('click',()=>{ showPage('home-page'); });
      document.getElementById('score-link').addEventListener('click',()=>{ renderTopScores(); showPage('score-page'); });

      document.getElementById('admin-link').addEventListener('click',()=>{
        if(!adminUnlocked){
          const p = prompt('Masukkan password Admin:');
          if(p===ADMIN_PASSWORD){ adminUnlocked=true; alert('Akses Admin dibuka.'); }
          else { alert('Password salah.'); return; }
        }
        showPage('admin-page');
      });

      document.getElementById('logout-link').addEventListener('click',logout);

      document.getElementById('start-game-btn').addEventListener('click',startGame);
      document.getElementById('next-question-btn').addEventListener('click',handleNextQuestion);
      document.getElementById('back-to-home-btn').addEventListener('click',()=>showPage('home-page'));
      document.getElementById('clear-scores-btn').addEventListener('click',()=>{
        if(confirm('Hapus semua top score?')){ appData.scores=[]; saveToLocalStorage(); renderTopScores(); alert('Top score direset.'); }
      });

      document.addEventListener('click',e=>{
        if(e.target.classList.contains('option')){
          document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
          e.target.classList.add('selected');
          appData.userAnswers[appData.currentQuestionIndex]=e.target.dataset.option;
        }
      });

      document.getElementById('add-question-btn').addEventListener('click',addQuestion);
      document.getElementById('export-questions-btn').addEventListener('click', exportQuestions);
      document.getElementById('import-questions-btn').addEventListener('click', importQuestionsPaste);
      document.getElementById('import-file-btn').addEventListener('click', ()=>document.getElementById('import-file').click());
      document.getElementById('import-file').addEventListener('change', importQuestionsFile);
    }

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    /* -------------------- LOGIN & HOME -------------------- */
    function renderAvatarOptions(){
      const c=document.getElementById('avatar-selection');
      c.innerHTML='';
      appData.avatars.forEach((src,idx)=>{
        const img=document.createElement('img');
        img.src=src; img.alt='Avatar '+(idx+1);
        img.className='avatar-option';
        if(idx===0 && !appData.currentPlayer.avatar){ appData.currentPlayer.avatar=src; img.classList.add('selected'); }
        if(appData.currentPlayer.avatar===src){ img.classList.add('selected'); }
        img.addEventListener('click',()=>{
          document.querySelectorAll('.avatar-option').forEach(i=>i.classList.remove('selected'));
          img.classList.add('selected');
          appData.currentPlayer.avatar=src;
        });
        c.appendChild(img);
      });
    }

    function renderThemeOptions(){
      const c=document.getElementById('theme-selection');
      c.innerHTML='';
      appData.themes.forEach((t,idx)=>{
        const el=document.createElement('div');
        el.textContent=t.name;
        el.className='theme-option';
        if((idx===0 && !appData.currentPlayer.theme) || appData.currentPlayer.theme===t.class){
          el.classList.add('selected');
          document.body.classList.add(t.class);
        }
        el.addEventListener('click',()=>{
          document.querySelectorAll('.theme-option').forEach(i=>i.classList.remove('selected'));
          el.classList.add('selected');
          document.body.classList.remove(...appData.themes.map(x=>x.class));
          document.body.classList.add(t.class);
          appData.currentPlayer.theme=t.class;
        });
        c.appendChild(el);
      });
    }

    function renderCategories(){
      const grid=document.getElementById('category-grid');
      grid.innerHTML='';
      appData.categories.forEach(cat=>{
        const box=document.createElement('div');
        box.className='category-item';
        box.innerHTML = `
          ${cat.image?`<img class="category-image" src="${cat.image}" alt="${cat.name}"/>`:''}
          <h3>${cat.name}</h3>
          <p>${cat.description||''}</p>
          <div class="level-buttons">
            <button class="btn btn-sm" data-category="${cat.id}" data-level="mudah">Mudah</button>
            <button class="btn btn-sm" data-category="${cat.id}" data-level="normal">Normal</button>
            <button class="btn btn-sm" data-category="${cat.id}" data-level="sulit">Sulit</button>
          </div>`;
        grid.appendChild(box);
        box.querySelectorAll('.level-buttons button').forEach(b=>{
          b.addEventListener('click',()=>startQuiz(b.dataset.category,b.dataset.level));
        });
      });
    }

    function startGame(){
      const name = (document.getElementById('player-name').value||'').trim();
      if(!name){ alert('Silakan isi nama dulu ya.'); return; }
      appData.currentPlayer.name=name;
      document.getElementById('player-greeting').textContent=name;
      saveToLocalStorage();
      showPage('home-page');
    }

    /* -------------------- QUIZ -------------------- */
    function startQuiz(category,level){
      appData.currentCategory=category;
      appData.currentLevel=level;
      appData.currentQuestionIndex=0;
      appData.userAnswers=[];
      appData.quizStartAt=Date.now();

      let qs=[];
      if(sampleQuestions[category] && sampleQuestions[category][level] && sampleQuestions[category][level].length){
        qs=sampleQuestions[category][level];
      }else{
        qs=[{id:1,question:`Contoh soal ${category} (${level})`,options:{a:'Opsi A',b:'Opsi B',c:'Opsi C',d:'Opsi D'},correctAnswer:'a',image:''}];
      }
      appData.currentQuestions=qs;

      document.getElementById('quiz-category').textContent='Kategori: '+category.toUpperCase();
      document.getElementById('quiz-level').textContent='Level: '+level;
      showPage('quiz-page');
      showQuestion(0);
    }

    function showQuestion(i){
      if(i>=appData.currentQuestions.length){ finishQuiz(); return; }
      const q=appData.currentQuestions[i];
      document.getElementById('question-text').textContent=q.question;
      document.getElementById('question-number').textContent=`Soal ${i+1}/${appData.currentQuestions.length}`;

      const qi=document.getElementById('question-image');
      if(q.image){ qi.src=q.image; qi.style.display='block'; }
      else { qi.style.display='none'; }

      document.getElementById('quiz-progress').style.width = (i/appData.currentQuestions.length*100)+'%';

      const oc=document.getElementById('options-container'); oc.innerHTML='';
      Object.entries(q.options).forEach(([k,v])=>{
        const d=document.createElement('div');
        d.className='option'; d.dataset.option=k; d.innerHTML=`<strong>${k.toUpperCase()}.</strong> ${v}`;
        if(appData.userAnswers[i]===k) d.classList.add('selected');
        oc.appendChild(d);
      });
    }

    function handleNextQuestion(){
      if(!appData.userAnswers[appData.currentQuestionIndex]){
        alert('Pilih jawaban dulu ya!');
        return;
      }
      appData.currentQuestionIndex++;
      showQuestion(appData.currentQuestionIndex);
    }

    function finishQuiz(){
      let score=0; const details=[];
      appData.currentQuestions.forEach((q,idx)=>{
        const ua=appData.userAnswers[idx];
        const ok=ua===q.correctAnswer;
        if(ok) score++;
        details.push({q:q.question,u:ua?q.options[ua]:'Tidak dijawab',c:q.options[q.correctAnswer],ok});
      });
      appData.currentPlayer.score=score;

      document.getElementById('score-display').textContent=`Skor Anda: ${score}/${appData.currentQuestions.length}`;
      const wrap=document.getElementById('answer-details'); wrap.innerHTML='';
      details.forEach((d,i)=>{
        const e=document.createElement('div');
        e.style.cssText=`margin:10px 0;padding:10px;border-left:4px solid ${d.ok?'#4caf50':'#f44336'};background:${d.ok?'#e8f5e9':'#ffebee'};border-radius:6px`;
        e.innerHTML=`<p><strong>Soal ${i+1}:</strong> ${d.q}</p><p><strong>Jawaban Anda:</strong> ${d.u}</p><p><strong>Jawaban Benar:</strong> ${d.c}</p>`;
        wrap.appendChild(e);
      });

      const ms = Math.max(1, Date.now()-appData.quizStartAt);
      addScore({
        name: appData.currentPlayer.name || 'Pemain',
        score, total: appData.currentQuestions.length,
        category: appData.currentCategory,
        level: appData.currentLevel,
        ms, date: new Date().toISOString()
      });

      showPage('result-page');
      saveToLocalStorage();
    }

    /* -------------------- TOP SCORE -------------------- */
    function addScore(rec){
      appData.scores.push(rec);
      appData.scores.sort((a,b)=>{
        if(b.score!==a.score) return b.score-a.score;
        if(a.ms!==b.ms) return a.ms-b.ms;
        return new Date(a.date)-new Date(b.date);
      });
      appData.scores = appData.scores.slice(0,100);
      saveToLocalStorage();
    }

    function renderTopScores(){
      const tbody = document.querySelector('#score-table tbody');
      const empty = document.getElementById('score-empty');
      tbody.innerHTML='';
      if(!appData.scores.length){
        empty.style.display='block';
        return;
      }
      empty.style.display='none';
      appData.scores.forEach((s,idx)=>{
        const tr=document.createElement('tr');
        const dur = Math.round(s.ms/1000)+' dtk';
        const tgl = new Date(s.date).toLocaleString('id-ID');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHTML(s.name)}</td>
          <td>${s.score}</td>
          <td>${s.score}/${s.total}</td>
          <td>${s.category.toUpperCase()}</td>
          <td>${s.level}</td>
          <td>${dur}</td>
          <td>${tgl}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* -------------------- ADMIN: BANK SOAL -------------------- */
    function renderCategoryOptionsForAdmin(){
      const sel=document.getElementById('question-category'); sel.innerHTML='';
      appData.categories.forEach(c=>{
        const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o);
      });
      sel.value='ipa';
    }

    function ensureCategory(cat){
      if(!sampleQuestions[cat]) sampleQuestions[cat]={mudah:[],normal:[],sulit:[]};
      ['mudah','normal','sulit'].forEach(l=>{ if(!Array.isArray(sampleQuestions[cat][l])) sampleQuestions[cat][l]=[]; });
    }

    function addQuestion(){
      const cat=document.getElementById('question-category').value;
      const lvl=document.getElementById('question-level').value;
      const qt=(document.getElementById('question-text').value||'').trim();
      const a=(document.getElementById('option-a').value||'').trim();
      const b=(document.getElementById('option-b').value||'').trim();
      const c=(document.getElementById('option-c').value||'').trim();
      const d=(document.getElementById('option-d').value||'').trim();
      const correct=document.getElementById('correct-answer').value;
      const imgField=document.getElementById('admin-image-url');
      const image = imgField && imgField.value ? imgField.value.trim() : '';

      if(!qt||!a||!b||!c||!d){ alert('Pertanyaan & semua opsi (A–D) wajib diisi.'); return; }
      if(!['a','b','c','d'].includes(correct)){ alert('Jawaban benar tidak valid.'); return; }

      ensureCategory(cat);
      sampleQuestions[cat][lvl].push({id:Date.now(),question:qt,options:{a,b,c,d},correctAnswer:correct,image});

      // reset form
      document.getElementById('question-text').value='';
      document.getElementById('option-a').value='';
      document.getElementById('option-b').value='';
      document.getElementById('option-c').value='';
      document.getElementById('option-d').value='';
      if(imgField) imgField.value='';

      alert('Soal ditambahkan!');
      saveToLocalStorage();
    }

    function mergeQuestions(target, incoming){
      if(!incoming || typeof incoming!=='object') return;
      Object.keys(incoming).forEach(cat=>{
        ensureCategory(cat);
        ['mudah','normal','sulit'].forEach(level=>{
          const arr = (incoming[cat] && incoming[cat][level]) ? incoming[cat][level] : [];
          arr.forEach(q=>{
            const exists = target[cat][level].some(x =>
              String(x.id)===String(q.id) || (x.question===q.question && JSON.stringify(x.options)===JSON.stringify(q.options))
            );
            if(!exists) target[cat][level].push(q);
          });
        });
      });
    }

    function exportQuestions(){
      const data = JSON.stringify(sampleQuestions, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bank-soal.json';
      document.body.appendChild(a); a.click(); a.remove();
    }

    function importQuestionsPaste(){
      const ta = document.getElementById('import-json');
      if(ta.style.display === 'none' || ta.style.display === ''){
        ta.style.display='block'; ta.focus();
        alert('Paste JSON bank soal ke kotak, lalu klik tombol ini lagi untuk impor.');
        return;
      }
      const raw = ta.value.trim();
      if(!raw){ alert('Kotak import masih kosong.'); return; }
      try{
        const incoming = JSON.parse(raw);
        mergeQuestions(sampleQuestions, incoming);
        saveToLocalStorage();
        ta.value=''; ta.style.display='none';
        alert('Bank soal berhasil diimpor (paste).');
      }catch(e){ console.error(e); alert('Format JSON tidak valid.'); }
    }

    async function importQuestionsFile(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      try{
        const text = await f.text();
        const incoming = JSON.parse(text);
        mergeQuestions(sampleQuestions, incoming);
        saveToLocalStorage();
        alert('Bank soal berhasil diimpor (file).');
      }catch(err){ console.error(err); alert('Gagal impor file JSON.'); }
      e.target.value='';
    }

    /* -------------------- STORAGE -------------------- */
    function saveToLocalStorage(){
      const data = {
        categories: appData.categories,
        questions: sampleQuestions,
        player: appData.currentPlayer,
        scores: appData.scores
      };
      localStorage.setItem('tebakTebakanData', JSON.stringify(data));
    }

    function loadFromLocalStorage(){
      const raw=localStorage.getItem('tebakTebakanData'); if(!raw) return;
      try{
        const data=JSON.parse(raw);
        if(data.categories) appData.categories=data.categories;
        if(data.questions) mergeQuestions(sampleQuestions, data.questions);
        if(Array.isArray(data.scores)) appData.scores = data.scores;
        if(data.player){
          appData.currentPlayer=data.player;
          document.getElementById('player-name').value=appData.currentPlayer.name||'';
          document.getElementById('player-greeting').textContent=appData.currentPlayer.name||'Pemain';
          if(appData.currentPlayer.theme){
            document.body.classList.remove(...appData.themes.map(t=>t.class));
            document.body.classList.add(appData.currentPlayer.theme);
          }
        }
      }catch(e){ console.warn('Parse localStorage gagal:', e); }
    }

    function logout(){
      if(!confirm('Yakin ingin logout?')) return;
      appData.currentPlayer={name:'Pemain',avatar:'',theme:'theme-light',score:0};
      showPage('login-page');
    }

    /* -------------------- UTIL -------------------- */
    function escapeHTML(s=''){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
  </script>
</body>
</html>
